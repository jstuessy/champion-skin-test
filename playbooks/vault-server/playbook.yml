---
- name: Setup Vault Server
  # TODO: make sure this is named subject_vault_server
  hosts: subject_vault
  vars:
    consul_version: "1.9.5"
    vault_version: "1.7.2"
  tasks:
    - import_role: 
        name: consul-agent
    - name: Ensure vault group exists
      ansible.builtin.group:
        name: vault
        state: present
      become: true
    - name: Ensure vault user exists
      ansible.builtin.user:
        name: vault
        group: vault
        system: true
        shell: /sbin/nologin
        createhome: false
      become: true
    - name: Ensure data directory exists
      ansible.builtin.file:
        path: /opt/vault
        state: directory
        owner: vault
        group: vault
      become: true
    - name: Ensure configuration directory exists
      ansible.builtin.file:
        path: /etc/vault.d
        state: directory
        owner: vault
        group: vault
      become: true
    - name: Download binary
      get_url:
        url: https://releases.hashicorp.com/vault/{{vault_version}}/vault_{{vault_version}}_linux_amd64.zip
        dest: /tmp/vault_{{vault_version}}_linux_amd64.zip
        owner: vault
        group: vault
        mode: "755"
      become: true
    - name: Unzip binary
      unarchive:
        src: /tmp/vault_{{vault_version}}_linux_amd64.zip
        dest: /usr/bin/
        remote_src: true
        owner: vault
        group: vault
        mode: "755"
      become: true
    - name: Verify that vault is usable
      command: "vault --version"
    # TODO: Rename to "vault-server"
    - name: Copy over systemd service file
      become: true
      ansible.builtin.template:
        src: vault.service.j2
        dest: /usr/lib/systemd/system/vault.service
        mode: "660"
        owner: vault
        group: vault
    - name: Copy over vault configuration files
      become: true
      ansible.builtin.template:
        src: "{{ item }}.j2"
        dest: "/etc/vault.d/{{ item }}"
        mode: "640"
        owner: vault
        group: vault
      loop:
        - "server.hcl"
        - "ui.hcl"
    # TODO: Rename to "vault-server"
    - name: Enable vault service
      become: true
      ansible.builtin.systemd:
        name: vault
        enabled: true
    # TODO: Rename to "vault-server"
    - name: Start vault service
      become: true
      ansible.builtin.systemd:
        name: vault
        state: started
    # TODO: Rename to "vault-server"
    - name: Restart vault service
      become: true
      ansible.builtin.systemd:
        name: vault
        state: restarted
    - name: Reload Daemon
      become: true
      ansible.builtin.systemd:
        daemon_reload: true